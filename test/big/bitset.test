# encoding: tarantool
#

import os
import shutil

for file in ("utils.lua", "bitset.lua"):
    src_path = os.path.join("big/", file)
    dst_path = os.path.join(vardir, file)
    shutil.copy(src_path, dst_path)
    exec admin "lua dofile('%s')" % (file)
    os.unlink(dst_path);

exec admin "lua fill(1, 128)"
exec admin "lua test(box.index.BITS_ALL)"

print """
#-----------------------------------------------------------------------------#
# BitsetIndex: BITS_ALL_SET (single bit)
#-----------------------------------------------------------------------------#
""";

exec admin "lua test(box.index.BITS_ALL_SET, 1)"
exec admin "lua test(box.index.BITS_ALL_SET, 2)"
exec admin "lua test(box.index.BITS_ALL_SET, 4)"
exec admin "lua test(box.index.BITS_ALL_SET, 8)"
exec admin "lua test(box.index.BITS_ALL_SET, 1073741824)"
exec admin "lua test(box.index.BITS_ALL_SET, 2147483648)"

exec admin "lua test(box.index.BITS_ALL_SET, 3)"
exec admin "lua test(box.index.BITS_ALL_SET, 7)"
exec admin "lua test(box.index.BITS_ALL_SET, 31)"
exec admin "lua test(box.index.BITS_ALL_SET, 5)"
exec admin "lua test(box.index.BITS_ALL_SET, 9)"
exec admin "lua test(box.index.BITS_ALL_SET, 27)"
exec admin "lua test(box.index.BITS_ALL_SET, 85)"
exec admin "lua test(box.index.BITS_ALL_SET, 2147483648)"
exec admin "lua test(box.index.BITS_ALL_SET, 2147483649)"
exec admin "lua test(box.index.BITS_ALL_SET, 4294967295)"

print """
#-----------------------------------------------------------------------------#
# BitsetIndex: BITS_ALL_NOTSET (single bit)
#-----------------------------------------------------------------------------#
""";

exec admin "lua test(box.index.BITS_ALL_NOTSET, 3)"
exec admin "lua test(box.index.BITS_ALL_NOTSET, 27)"
exec admin "lua test(box.index.BITS_ALL_NOTSET, 85)"
exec admin "lua test(box.index.BITS_ALL_NOTSET, 4294967295)"

print """
#-----------------------------------------------------------------------------#
# BitsetIndex: BITS_ANY_SET (single bit)
#-----------------------------------------------------------------------------#
""";

exec admin "lua test(box.index.BITS_ANY_SET, 0)"
exec admin "lua test(box.index.BITS_ANY_SET, 84)"

print """
#-----------------------------------------------------------------------------#
# BitsetIndex: BITS_ANY_NOTSET (single bit)
#-----------------------------------------------------------------------------#
""";

exec admin "lua test(box.index.BITS_ANY_NOTSET, 1)"

exec admin "lua clear()"
# Empty
exec admin "lua test(box.index.BITS_ALL)"

exec admin "lua fill(113, 1024)"

print """
#-----------------------------------------------------------------------------#
# BitsetIndex: BITS_ALL_SET (multiple bit)
#-----------------------------------------------------------------------------#
""";

exec admin "lua test(box.index.BITS_ALL_SET, 3)"
exec admin "lua test(box.index.BITS_ALL_SET, 7)"
exec admin "lua test(box.index.BITS_ALL_SET, 10)"
exec admin "lua test(box.index.BITS_ALL_SET, 341)"

print """
#-----------------------------------------------------------------------------#
# BitsetIndex: remove all
#-----------------------------------------------------------------------------#
""";

exec admin "lua clear()"
# Empty
exec admin "lua test(box.index.BITS_ALL)"
exec admin "lua fill(1, 16)"

print """
#-----------------------------------------------------------------------------#
# BitsetIndex: BITS_ANY_SET (multiple bit)
#-----------------------------------------------------------------------------#
""";

exec admin "lua test(box.index.BITS_ANY_SET, 7)"
exec admin "lua test(box.index.BITS_ANY_SET, 10)"

print """
#-----------------------------------------------------------------------------#
# BitsetIndex: BITS_ALL_NOTSET (multiple bit)
#-----------------------------------------------------------------------------#
""";

exec admin "lua test(box.index.BITS_ALL_NOTSET, 7)"
exec admin "lua test(box.index.BITS_ALL_NOTSET, 10)"

print """
#-----------------------------------------------------------------------------#
# BitsetIndex: stress test
#-----------------------------------------------------------------------------#
""";

exec admin "lua n = 1024"
exec admin "lua t = {2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53}"
exec admin "lua clear()"
exec admin "lua fill(1, n)"
exec admin "lua for _, v in ipairs(t) do remove(v, n / v) end"
exec admin "lua test(box.index.BITS_ALL_SET, 63)"
exec admin "lua clear()"
# Empty
exec admin "lua test(box.index.BITS_ALL)"
